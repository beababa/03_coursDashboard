---
title: "Représentations parcelles typologie"
author: "B. Maranget"
date: "16/12/2020"
output: 
  html_document: 
    number_sections: yes
    toc: yes
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
# Passer la valeur suivante à TRUE pour reproduire les extractions.
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

# Objet

Donner des outils pour pouvoir traiter les données "parcelles".

- spatialisation d'un fichier .csv lambda
- recherche de doublons géographqiues
- utilisation fonctions spatiales : appartenance (st_within), dispersion (st_jitter)
- cartographie par lot à l'échelle du pays et des bassins de production
- cartographie typologique (fonction typoLayer)
- sorties graphiques par lot (png () et dev.off())

## Librairies et répertoire

```{r}
library(sf)
library(cartography)
library(rnaturalearth) # pour le fond de carte
```

# Préparer la donnée

## Données

```{r}
# couches division administratives ign dans un fichier .gpkg format ouvert de données
commune <- st_read("../dataE/00_ADMIN/ign.gpkg", "commune", quiet = TRUE,stringsAsFactors = F)
dpt <- st_read("../dataE/00_ADMIN/ign.gpkg", "dpt", quiet = TRUE, stringsAsFactors = F)
region <- st_read("../dataE/00_ADMIN/ign.gpkg", "region", quiet = TRUE, stringsAsFactors = F)
# exemple d'un autre format, le shape
pays <- st_read("../dataE/00_ADMIN/France_l93_continent4_buf2.shp", quiet = TRUE, stringsAsFactors = F)
# chargement donnée
data <- read.csv("../dataE/02_POI/parcelles.csv")
```

Bassins de production Arvalis

```{r}
bp <- st_read("../dataE/01_CULTURES/arvalis.gpkg", "bp")
bp <- aggregate(bp [, c("bassin")], by = list(bp$bassin), length)
names(bp) [1:2] <- c("ID", "Nb_dpts")
st_write(bp, "../dataS/arvalis.gpkg", "bp", quiet = TRUE, delete_layer = TRUE)
```




## Spatialisation du fichier

Le problème, les . et les , dans les coordonnées et le type de la donnée

```{r}
# remplacements des virgules
data$x <- gsub(",", ".",data$x) 
data$y <- gsub (",",".", data$y)
data$x <- as.numeric(data$x)
data$y <- as.numeric(data$y)
# spatialisation
data.sf <- st_as_sf(data, coords = c("x", "y"), crs = 2154)
```

## Déterminer les communes d'appartenance : st_within


Cette fonction spatiale renvoie une liste contenant les indices des communes.


```{r}
indiceCommune <- st_within(data.sf, commune, sparse = TRUE)
indiceCommune <- unlist(indiceCommune)
names(commune)
comSel <- commune [indiceCommune, c("INSEE_COM", "NOM_COM"), drop = TRUE]
# on lie la table des points et les communes
data <- cbind(data.sf, comSel)
tab <- table(data$INSEE_COM)
# désormais on utilise la variable data
```

## Etude des points en doublon

```{r}
# Combien ?
table(tab)
# étude du cas des 5 pts sur 1 commune
code5 <- names (tab [tab == 5])
data5 <- data [data$INSEE_COM == code5,]
```


## Déplacement des points (st_jitter)



```{r}
data.jitter <- st_as_sf(st_jitter(data$geometry, 10000))
data5.jitter <- st_as_sf(st_jitter(data5$geometry, 10000))
# visualisation, cas de Millau
plot (commune$geom [commune$NOM_COM == "Millau",], bg = "antiquewhite1")
plot (data5.jitter, add = TRUE)
layoutLayer("5 points sur Millau")
# donc un point un peu loin... mais ça dépend de l'échelle !
```

# Cartographies

## Couleurs


```{r}
mycol<-c("skyblue","slategray1","grey","navy","orchid","lightyellow3","yellow",
         "orange3","green","forestgreen","blue","slategray3","red","plum","darkseagreen1",
         "darkseagreen","sandybrown","gold2","cyan")
```


## Une carte par catégorie, échelle nationale


```{r}
i <- 1
for (i in 1:15) {
  # paramétrage sortie graphique
  png(paste0 (
    "../img/groupe",
    i,
    ".png"),
    width = 800,
    height = 800 ,
    res = 100
  )
  # fond de carte toujours en antiquewhite / et mers en bleu
  par(mar = c(0, 0, 1.2, 0))
  # affichage du fond
  fond <- ne_countries(scale = "medium", returnclass = "sf")
  fond <- st_transform(fond, crs = 2154)
  # on centre sur la France
  plot(pays$geometry, border = NA, bg = "lightblue1")
  plot (fond,
        border = NA,
        col = "antiquewhite1",
        add = TRUE)
  plot (bp$geom, col = NA, border = "antiquewhite2",add = TRUE)
  # filtrage et dispersion de la donnée
  dataSel <-  data [data$groupe == i, ]
  dataSel.jitter <-  st_as_sf(st_jitter(dataSel$geometry, 20000))
  plot(dataSel.jitter,
       pch = 19,
       col = mycol [i],
       add = TRUE)
  # titre de la carte
  layoutLayer(title = paste0 ("Groupe ", i, " - ", length(dataSel$groupe), " parcelles"))
  dev.off()
}
```




## Typologie, échelle bassin de production



```{r}
i <- 1
for (i in 1:8) {
  bpSel <-  bp [i,]
  # paramétrage sortie graphique
  png(paste0 (
    "../img/bp",
    i,
    ".png"),
    width = 800,
    height = 800 ,
    res = 100
  )
  # fond de carte toujours en antiquewhite / et mers en bleu
  par(mar = c(0, 0, 1.2, 0))
  # affichage du fond
  fond <- ne_countries(scale = "medium", returnclass = "sf")
  fond <- st_transform(fond, crs = 2154)
  # on centre sur le bp
  plot(bpSel$geometry)
  plot(bpSel$geometry, border = NA, bg = "lightblue1")
  plot (fond,
        border = NA,
        col = "antiquewhite1",
        add = TRUE)
  # bordures de tous les bp
  plot (bp$geom, col = NA, border = "antiquewhite2",add = TRUE)
  # filtrage spatiale de la donnée et dispersion
  dataSel <-  st_intersection(data, bpSel)
  dataSel.jitter <-  st_as_sf(st_jitter(dataSel$geometry, 20000))
  # concaténation variable / jitter
  dataSel.jitter <- cbind(dataSel.jitter, dataSel$groupe)
  # on fixe les couleurs en fonction des catégories
  tab <- table(dataSel.jitter$dataSel.groupe)
  print(names(tab))
  mycolSel <-  mycol [as.integer(names(tab))]
  print(mycolSel)
  ordre <- names(tab)
  typoLayer(dataSel.jitter, var = "dataSel.groupe",
       col = mycolSel, lwd = 6, legend.values.order = ordre,
       legend.title.txt = "Groupe",
       add = TRUE)
  # titre de la carte
  layoutLayer(title = paste0 ("Bp ", i, " - ", nrow(dataSel), " parcelles"))
  dev.off()
}


```

![](../img/bp1.png)
![](../img/bp2.png)
![](../img/bp3.png)
![](../img/bp4.png)
![](../img/bp5.png)
![](../img/bp6.png)
![](../img/bp7.png)
![](../img/bp8.png)
![](../img/groupe1.png)
![](../img/groupe10.png)
![](../img/groupe11.png)
![](../img/groupe12.png)
![](../img/groupe13.png)
![](../img/groupe14.png)
![](../img/groupe15.png)
![](../img/groupe2.png)
![](../img/groupe3.png)
![](../img/groupe4.png)
![](../img/groupe5.png)
![](../img/groupe6.png)
![](../img/groupe7.png)
![](../img/groupe8.png)
![](../img/groupe9.png)




